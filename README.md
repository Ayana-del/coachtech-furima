# coachtech-furima

coachtech フリマアプリの開発プロジェクトです。

## アプリケーションの概要

本アプリケーションは、ユーザーが商品を自ら出品・購入できるフリマプラットフォームです。

## 使用技術（実行環境）

## ■ 使用技術（実行環境）

開発環境および使用している主要な技術スタックは以下の通りです。

### 1. 開発インフラ / サーバー構成

| 項目         | 技術 / バージョン                            |
| ------------ | -------------------------------------------- |
| インフラ     | Docker / Docker Compose                      |
| Web サーバー | Nginx 1.21.1                                 |
| データベース | MySQL 8.0.35                                 |
| ツール       | phpMyAdmin (DB 管理), MailHog (メールテスト) |

### 2. バックエンド (Backend)

| 項目           | 技術 / バージョン                                |
| -------------- | ------------------------------------------------ |
| 言語           | PHP 8.1                                          |
| フレームワーク | Laravel 8.x                                      |
| 認証パッケージ | Laravel Fortify (会員登録・ログイン・メール認証) |

### 3. フロントエンド (Frontend)

| 項目                 | 技術             |
| -------------------- | ---------------- |
| テンプレートエンジン | Blade            |
| スタイリング         | CSS (Native CSS) |

## 環境構築手順

クローン後、以下の手順で開発環境を起動できます。

### 1.リポジトリのクローン

```bash
git clone https://github.com/Ayana-del/coachtech-furima.git
```

```bash
cd coachtech-furima
```

### 2.Docker コンテナの構築・起動

```bash
docker-compose up -d --build
```

### 3.依存パッケージのインストール

```bash
cp src/.env.example src/.env
```

```bash
docker-compose exec php php artisan key:generate
```

### 5.マイグレーションの実行

```bash
docker-compose exec php php artisan migrate
```

### 6.初期データの投入

開発および動作確認のため、以下の手順でダミーデータを投入してください。

```bash
php artisan migrate:fresh --seed
```

重要: データの整合性を保つため、DatabaseSeeder は以下の順序で実行されるよう構成されています。  
1.UsersTableSeeder（テスト用アカウント 3 種）  
2.ProfilesTableSeeder（各ユーザーの住所情報）  
3.ConditionsTableSeeder（商品の状態マスター）  
4.ItemsTableSeeder（出品者 ID:1 による商品サンプル 10 件）

テストおよび動作確認のため、以下のデータをシーディングにより投入しています。

### １.テスト用アカウント

状態の異なる３名のユーザーを用意しています。  
| ユーザー役割 | メールアドレス | パスワード | 認証状態 | 確認できる要件 |  
| ---- | ---- | ---- | ---- | ---- |  
| 出品者(ID:1) | test@example.com | password123 | 認証済み | 自分の商品が一覧に表示されない |  
| 購入者 (ID:2) | buyer@example.com | password123 | 認証済み | 他者の商品の閲覧・購入・いいね |  
| 未認証者(ID:3) | guest@example.com | password123 | 未認証 | ログイン後のメール認証誘導 |

### 2.プロフィール初期データ

各ユーザーには、購入時の配送先初期値として利用されるプロフィール情報が紐付けられています。  
・登録項目: 名前、郵便番号、住所、建物名  
・設定例: ユーザー ID:2（購入者）には「大阪府大阪市北区...」が設定されており、購入画面の初期住所として反映されます。

### 3. 商品・状態データ

ユーザー ID:1（出品者）によって、以下の 10 点の商品が登録されています。  
| 商品名 | 価格 | ブランド | 商品の状態 |  
| ---- | ---- | ---- | ---- |
| 腕時計 | ¥15,000 | Rolax | 良好 |  
| HDD | ¥5,000 | 西芝 | 目立った傷や汚れなし |  
| 玉ねぎ 3 束 | ¥300 | - | 良好 |  
| 革靴 | ¥4,000 | - | やや傷や汚れあり |  
| ノート PC | ¥45,000 | - | 良好 |  
| マイク | ¥8,000 | - | 良好 |  
| ショルダーバッグ | ¥3,500 | - | 良好 |  
| タンブラー | ¥500 | - | 良好 |  
| コーヒーミル | ¥4,000 | Starbacks | 良好 |  
| メイクセット | ¥2,500 | - | 良好 |

## 開発・管理ツール

環境構築完了後、以下の URL から各機能にアクセスできます。  
| サービス名 | URL | 備考 |  
| ---- | ---- | ---- |  
| アプリケーション本体 | http://localhost | 動作確認用メインページ |  
| phpMyAdmin | http://localhost:8080 | データベース管理ツール |  
| MailHog / Mailtrap | http://localhost:8025 | 送信メール確認用 |

phpMyAdmin 接続情報  
データベースの値を直接確認・変更する際は、以下の設定でログインしてください。  
サーバー名: mysql  
ユーザー名: laravel_user  
パスワード: laravel_pass

## ER 図

![ER図](./er-diagram.drawio.png)

## データベース設計　

本プロジェクトは、機能要件に基づき、９つのテーブルで構成されています。  
| テーブル名 | 役割 |  
| ---- | ---- |  
| users | ログインユーザーの認証情報を管理します。 |  
| profiles | ユーザーの詳細情報を保持します。 |  
| items | 出品情報を管理します。 |  
| categories | カテゴリ名を管理するマスターテーブルです。 |  
| category_item | 1 つの商品に複数のカテゴリを紐づけるための中間テーブルです。 |  
| comments | 商品に対するユーザーからのコメント内容と投稿時間を保持します。 |  
| likes | どのユーザーがどの商品に「いいね」をしたのかの履歴を保持します。 |  
| orders | 購入確定時の商品 ID、購入者 ID、および配送先情報を保持します。 |  
| condition | 商品の状態を管理するマスタデーブルです。 |

## モデル・リレーション定義

Eloquent モデルにおける主要なリレーションシップを以下に定義しています。

■ User モデル  
| メソッド名 | リレーション | 相手モデル | 内容 |  
| ---- | ---- | ---- | ---- |  
| profile() | hasOne | Profile | 一つのプロフィールを保持 |  
| items() | hasMany | Item | 複数の商品を出品する |  
| comments() | hasMany | Comment | 複数のコメントを投稿する |  
| likes() | hasMany | Like | 複数の「いいね」を行う |  
| favoriteItems() | belongToMany | Item | 「いいね」した全商品を取得（マイリスト） |  
| orders() | hasMany | Order | 複数の購入（注文）履歴を持つ |

■ Profile モデル  
| メソッド名 | リレーション | 相手モデル | 内容 |  
| ---- | ---- | ---- | ---- |  
| user() | belongsTo | User | 持ち主であるユーザーを特定 |

■ Item モデル  
| メソッド名 | リレーション | 相手モデル | 内容 |  
| ---- | ---- | ---- | ---- |  
| user() | belongsTo | User | 出品者を特定 |  
| categories() | belongsToMany | Category | 複数のカテゴリに属する |  
| comments() | hasMany | Comment | 商品についた全コメントを取得 |  
| likes() | hasMany | Like | 商品についた「いいね」を取得 |  
| order() | hasOne | Order | 注文の有無で「購入済み」を判断 |

■ Category モデル  
| メソッド名 | リレーション | 相手モデル | 内容 |  
| ---- | ---- | ---- | ---- |  
| items() | belongsToMany | そのカテゴリに属する全商品を取得 |

■ Order モデル  
| メソッド名 | リレーション | 相手モデル | 内容 |  
| ---- | ---- | ---- | ---- |  
| user() | belongsTo | User | 購入者を特定 |  
| items() | belongsTo | Item | 購入された商品を特定 |

■ Comment モデル  
| メソッド名 | リレーション | 相手モデル | 内容 |  
| ---- | ---- | ---- | ---- |  
| user() | belongsTo | User | 投稿者を特定 |  
| items() | belongsTo | Item | 対象の商品を特定 |

■Like モデル  
| メソッド名 | リレーション | 相手モデル | 内容 |  
| ---- | ---- | ---- | ---- |  
| user() | belongsTo | User | 「いいね」した人を特定 |  
| item() | belongsTo | Item | 対象の商品を特定 |

## コントーローラー定義

各コントローラーの役割と、実装されている主要メソッドの詳細です。

■ ItemController（商品関連）  
| メソッド名 | 役割 | 処理内容 |  
| ---- | ---- | ---- |  
| index | 商品一覧 / マイリスト表示 | ・自分以外の出品商品を表示。<br>・キーワード検索に対応。<br>・`mylist`タブ選択時、自分が「いいね」した商品のみを抽出。 |  
| show | 商品詳細表示 | ・カテゴリ、状態、コメント、いいね情報を一括取得（Eager Load）。<br>・ログインユーザーの「いいね」済み判定を実施。 |

■ MypageController（マイページ）  
| メソッド名 | 役割 | 処理内容 |  
| ---- | ---- | ---- |  
| index | マイページ表示 | ・プロフィール情報をロード。<br>・出品した商品（`sellItems`）と購入した商品（`buyItems`）を同時に取得。 |

■. ProfileController（プロフィール管理）  
| メソッド名 | 役割 | 処理内容 |  
| ---- | ---- | ---- |  
| edit | プロフィール編集画面表示 | ログインユーザーの現在のプロフィール設定値をビューへ渡します。 |  
| update | プロフィール更新 | ・氏名、住所、画像等のバリデーションと更新。<br>・既存画像がある場合は削除した上で新画像を保存。<br>・`users`と`profiles`の両テーブルを更新。 |

## ルーティング定義

### 1.公開ルート

未ログインの状態でも閲覧可能なページです。  
| URL | メソッド | ルート名 | 担当コントローラー | 処理内容 |  
| ---- | ---- | ---- | ---- | ---- |  
| / | GET | item.index | ItemController@index | 商品一覧画面の表示 |  
| /item/{item_id} | GET | item.show | ItemController@show | 商品詳細画面の表示 |

### 2.要認証ルート（メール認証済みのユーザーのみ）

ログインしており、かつメール認証が完了しているユーザーのみがアクセス可能です。  
| URL | メソッド | ルート名 | 担当コントローラー | 処理内容 |  
| ---- | ---- | ---- | ---- | ---- |  
| /mypage | GET | mypage | MypageController@index | ユーザーマイページの表示 |  
| /mypage/profile | GET | profile.edit | ProfileController@edit | プロフィール編集画面の表示 |  
| /mypage/profile | POST | profile.store | ProfileController@update | プロフィール情報の更新処理 |

### 3.メール認証関連・遷移関連

メール認証のプロセスおよび、認証完了時のリダイレクトを制御するルートです。  
| URL | メソッド | ルート名 | 処理内容 |  
| ---- | ---- | ---- | ---- |  
| /email/verify | GET | verification.notice | メール認証が必要な旨を伝える誘導画面を表示。 |  
| /email/verification-notification | POST | verification.send | 認証メールを再送信する処理 |  
| /email/verify/{id}/{hash} | GET | verification.verify | 初回認証完了時のみ「プロフィール編集画面」へ遷移。 |  
  
## 会員登録・メール認証機能の実装

### 1.実装済み機能

・ユーザー登録：ユーザー名、メールアドレス、パスワードによる新規アカウント作成。  
・バリデーション：FormRequest を使用したサーバーサイドでの入力チェック。  
・メール認証：新規登録時の本人確認メール送信機能追加。  
・レスポンシブ・デザイン：PC(1400px - 1540px)とタブレット(768px - 850px)に対応。

### 2.実装ファイル一覧

| ファイルパス                                | 役割・実装内容                                          |
| ------------------------------------------- | ------------------------------------------------------- |
| app/Http/Requests/RegisterRequest.php       | バリデーション定義ルール・指定エラーメッセージの定義    |
| routes/web.php                              | メール認証完了後の /mypage/profile へのリダイレクト制御 |
| config/fortify.php                          | 認証済みユーザーの Home（/） 設定                       |
| resources/views/auth/register.blade.php     | 会員登録画面のマークアップ                              |
| resources/views/auth/verify-email.blade.php | メール認証誘導画面                                      |

### 3.ユーザー登録・遷移フロー

・登録後のフロー：会員登録語、メール認証誘導画面を表示します。認証未完了ユーザーは、ログイン後も自動的にこの画面へ誘導されるよう制御しています。

・認証完了後のリダイレクト:メールの認証リンクをクリックした初回のみ、必須情報の登録を促すため プロフィール設定画面（/mypage/profile） へ自動遷移します。

・通常ログイン時: 二回目以降のログイン時は、利便性を考慮し 商品一覧ページ（/） または マイページ（/mypage） へ遷移するよう、config/fortify.php にてカスタマイズ済みです。

## ログイン・認証制限機能の実装

### 1.実装済み機能

・ユーザー認証：登録済みメールアドレスとパスワードによる認証処理。  
・バリデーション：LoginRequest による入力チェックおよび日本語メッセージの返却。  
・未認証リダイレクト：Authenticate ミドルウェアにより、未ログイン状態での保護ページアクセスをログイン画面へ強制誘導。  
・画面間遷移制限：ログイン画面と会員登録画面を相互に遷移可能な動線を構築。

### 2.実装ファイル

ログイン認証および、ユーザー状態に応じたリダイレクト制御に関連する主要ファイルは以下の通りです。  
| ファイルパス | 役割・実装内容 |
| ------------------------------------ | -------------------------------------------------- |
| app/Http/Requests/LoginRequest.php | ログイン専用のバリデーションルール・メッセージ定義 |
| resources/views/auth/login.blade.php | ログイン画面 |
| public/css/auth/auth.css | 会員登録画面・ログイン画面共通デザイ |
| config/fortify.php | 認証済みユーザーの標準リダイレクト先（home）の設定 |  
| routes/web.php | 初回メール認証完了時のプロフィール画面遷移ロジックを実装 |  
| app/Http/Middleware/Authenticate.php | 未ログイン状態でのアクセス制限とログイン画面への誘導 |

### 3.機能要件に基づく挙動

・アクセス制限:認証が必要なページ（マイページや購入画面など）への未ログインアクセスを検知した際、自動的にログイン画面へ遷移させます。

・未認証ユーザーの保護:ログイン済みであっても、メール認証が完了していないユーザーが保護ページへアクセスした場合は、自動的に メール認証誘導画面（/email/verify） へ遷移させ、機能を制限します。

・認証後の遷移最適化: 認証成功後のリダイレクト先は、ユーザーの状態に応じて以下の通り動的に切り替えます。  
　・初回メール認証完了時: プロフィール設定画面（必須情報登録を優先）  
　・通常ログイン時: 商品一覧画面

・エラーフィードバック:ログイン不備がある場合、「ログイン情報が登録されていません」などの指定されたメッセージを表示し、ユーザーへ通知します。

## ■ 商品一覧・マイリスト・検索機能

### 1. 実装済み機能

・商品一覧表示（おすすめ）: 全商品の画像・名称を表示。購入済み商品は「Sold」ラベルを表示。

・出品者除外ロジック: ログイン中の場合、自分が出品した商品は一覧に表示されません（要件 FN014-4）。

・マイリスト機能: 「いいね」した商品のみを表示。未ログイン時は空の状態で安全に処理。

・インクリメンタル検索: ヘッダーの検索窓から「商品名」で部分一致検索が可能。タブを切り替えても検索ワードを維持するステートフルな検索機能を実装。

### 2. 実装ファイル  
| ファイルパス | 役割 | 実装内容 |  
| ---- | ---- | ---- |  
| app/Http/Controllers/ItemController.php | 一覧取得、自分以外の出品物抽出、検索ロジック |  
| resources/views/item/index.blade.php | おすすめ/マイリストのタブ切り替えおよび検索窓のUI |  
| app/Models/Item.php | 検索用スコープや購入済み判定（Sold）の定義 |  
  
## ■ マイページ機能  
### 1. 実装済み機能  
・プロフィール表示: ユーザー名、プロフィール画像の動的表示（未設定時のデフォルト画像対応）。  

・商品リストの出し分け:  

　・出品した商品: items テーブルより自身が user_id となっているデータを取得。  

　・購入した商品: orders テーブルとリレーションし、自身が購入した商品のみを抽出。  

・タブ切り替え UI: JavaScript を活用し、ページリロードなしで「出品物」と「購入物」を切り替える快適な操作感を提供。  
  
### 2. 実装ファイル  
| ファイルパス | 役割・実装内容 |  
| ---- | ---- |
| app/Http/Controllers/MypageController.php | 出品/購入商品の取得、プロフィールデータの統合 |  
| resources/views/mypage/index.blade.php | マイページUI、タブ切り替えスクリプト |  
| app/Models/User.php | items()（出品）および orders()（購入）のリレーション定義 |  
  
## ■ 商品詳細機能  
商品の詳細情報閲覧、お気に入り登録（いいね）、およびユーザー間のコミュニケーション（コメント）機能を提供します。  

### 1. 実装済み機能  
詳細情報の網羅的表示:  

・商品画像、商品名、ブランド、価格、商品説明を動的に表示。  

・複数カテゴリ対応: 商品に紐づく複数のカテゴリをすべてリスト表示。  

・情報の出し分け: 未認証ユーザーにも詳細情報の閲覧を許可。  

動的な「いいね」機能:  

・ログインユーザーはアイコン押下で「いいね」の登録/解除が可能。  

・リアルタイム反映: 押下後、合計カウント数が即座に増減し、アイコンの色が変化。  

コメント送信機能（要件 FN020）:  

・ログインユーザーのみコメント投稿が可能。  

・バリデーション: FormRequest を使用し、未入力チェックおよび最大255文字の制限を実装。  

・投稿後、コメント一覧に即時反映され、コメント総数も更新。  

購入動線:  

・「購入手続きへ」ボタンより、商品購入画面へシームレスに遷移。  

### 2. 実装ファイル一覧

| ファイルパス | 役割・実装内容 |
| ---- | ---- |
| app/Http/Controllers/ItemController.php | 詳細情報の取得、いいね数・コメント数の集計 |
| app/Http/Requests/CommentRequest.php | コメント投稿時のバリデーション（必須・255文字制限） |
| app/Http/Controllers/LikeController.php | いいねの登録・削除ロジック |
| app/Http/Controllers/CommentController.php | コメント保存および商品詳細へのリダイレクト処理 |
| resources/views/item/show.blade.php | 詳細画面のUI、カテゴリのループ表示、コメント一覧 |

## プロフィール編集画面  
ユーザーが自身の情報を管理するための「プロフィール編集画面」および、「ユーザー情報変更機能」を実装。  
### 1.対応要件一覧  
■ ユーザー情報変更機能  
以下の項も項について、過去の設定値を初期値として表示し、更新できる機能を実装しました。  
・プロフィール画像：  
 ・保存先：Laravelのstorage/app/public/profiles ディレクトリ  
 ・ブラウザ表示用のシンボリックリンク設定済み（php artisan storage:link）  
  
・ユーザー名: users テーブルおよび profiles テーブルとの連携  
  
・郵便番号: 8桁制限  
  
・住所: profiles テーブルへの保存  
  
・建物名: 任意入力項目として実装  
  
■ マイページ連携. 
・プロフィール表示: マイページにて画像とユーザー名が正しく取得・表示されることを確認。  
・動線: マイページからプロフィール編集画面への遷移ボタンを配置。  
  
### 2.技術的仕様  
・データベース構成: profiles テーブルを新規作成し、user_id による users テーブルとの外部キー制約（cascadeOnDelete）を設定。  
  
・画像処理:  
 ・画像未設定時はデフォルトのプレビュー（👤）を表示。  
  
・リアルタイム・プレビュー: JavaScriptを用いて、保存前に選択した画像を即座に確認可能。  
  
・画像削除機能: 任意でプロフィール画像を解除し、初期状態（画像なし）に戻せる機能。  
  
・スマート・アップロード: 新しい画像が保存される際、サーバー内の古い不要ファイルを自動削除するクリーン設計。  
### 3.使用技術・環境  
・Backend: PHP 8.x / Laravel 10.x (Eloquent ORM)  

・Frontend: JavaScript (File API), CSS3 (Responsive Design)  

・Database: MySQL / PostgreSQL (Unique Constraints)  

・Storage: Laravel Storage (Public Disk)  




